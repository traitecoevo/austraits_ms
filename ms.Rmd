---
title: "Austraits -- a curated plant trait database for the Australian flora"
csl: assets/nature.csl
editor_options:
  chunk_output_type: console
output:
  word_document:
    reference_docx: assets/manuscriptstyle.docx
bibliography: references.bib
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
root.dir = rprojroot::find_root("austraits_ms.Rproj")
knitr::opts_knit$set(root.dir = root.dir)
knitr::opts_chunk$set(echo=FALSE, cache=FALSE, results='asis', message=FALSE, warning=FALSE)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(knitr)
library(tidyverse)
library(rmarkdown)

source("R/ms.R")
```

```{r authors, results='asis', echo=FALSE}
authors <- read_csv("data/authors.csv", col_types = cols(.default = "c"))

affils <- tibble(Affiliation=unique(authors$Affiliation), 
                 label = letters[seq_len(length(Affiliation)) ])
authors <- left_join(authors, affils, by = "Affiliation")

# print list of authors
sprintf("%s^%s^", authors$Author, authors$label) %>% paste0(collapse = ", ") %>% writeLines()

writeLines("\n\n")

# print list of affiliations
sprintf("^%s^ %s", affils$label, affils$Affiliation) %>% paste0(collapse = "; ") %>% writeLines()
```

```{r austraits}


## Assumes to items exist in global name space
austraits <- readRDS("data/austraits.rds")

definitions <- austraits$definitions

tmp <- RefManageR::WriteBib(austraits$sources, "references.bib")

sources_all <- 
  bind_rows(
    austraits$methods %>% select(dataset_id, citation = source_primary_key) %>% 
            distinct() %>% mutate(type="primary"),
    austraits$methods %>% select(dataset_id, citation = source_secondary_key) %>% 
            distinct() %>% mutate(type="secondary")
  ) %>% 
  na.omit() %>% 
  arrange(dataset_id) %>% 
  group_by(dataset_id) %>% 
  summarise(refs = sprintf("@%s", citation) %>% 
  paste(collapse = "; "))

```

# Overview

AusTraits harmonises data on `r austraits$traits$trait_name %>% unique() %>% length()` traits from `r austraits$methods$dataset_id %>% unique() %>% length()` different sources, including field campaigns, published literature, taxonomic monographs, and individual species descriptions.

This document provides information on the structure of AusTraits and corresponds to Version `r austraits$definitions$austraits$elements$build_info$elements$version$value` of the dataset. 

# Data structures

# Figures  

![**Figure 1. The data curation pathway used to assemble the AusTraits database.** Trait observations are accessed from original data sources, including published floras and field campaigns. Factors such as units and taxonomy are harmonised to a common standard. Versioned releases are distributed to users, allowing the dataset to be used and re-used in a reproducible way. Errors are corrected and new datasets added via the blue path for sequential releases of the database.](figures/Pipeline.png)
  
  

![**Figure 2.** (a.) Locations where the trait data were collected and the corresponding number of species. (b.) AusTraits’ sites (grey) within Australia’s precipitation-temperature space (black) superimposed upon Whittaker’s major biomes diagram. Data from WorldClim (worldclim.org). (c.) Overview of the number of species with which traits are measured within each major plant organ and trait category.](figures/austraits_fig2_blue.png)

![**Figure 3.** The phylogenetic representation of traits in the AusTraits database for the subset of 2000 randomly sampled species. The heatmap colour intensities denote the number of traits measured within each major plant organ. The most widespread family names (with more than ten species) are labelled on the edge of the tree.](figures/austraits_phlogenetic_coverage.png)

<!-- Cite: -->
  <!-- G Yu, DK Smith, H Zhu, Y Guan, TTY Lam*. ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data. Methods in Ecology and Evolution. 2017, 8(1):28-36. doi: 10.1111/2041-210X.12628.  -->
  <!-- G Yu*, TTY Lam, H Zhu, Y Guan*. Two methods for mapping and visualizing associated data on phylogeny using ggtree. Molecular Biology and Evolution, 2018, 35(2):3041-3043. doi: 10.1093/molbev/msy194. -->


# Tables  

Table 1:  Main elements of Austraits

```{r}
tibble(
  Element = names(austraits), 
  Contents = sapply(austraits$definitions$austraits$elements, "[[", "description") 
  ) %>% 
  kable()
```

Table 2: Traits represented in database
```{r}
sites <- austraits$sites %>% 
  filter(site_property %in%  c("longitude (deg)","latitude (deg)")) %>% 
  spread(site_property, value)

trait_categories <- read_csv("data/trait_categories.csv", col_types = cols(.default = "c"))

data_geo <- 
  left_join(by=c("dataset_id", "site_name"),
      select(austraits$traits, -original_name), sites) %>%
  left_join(by="species_name",
      select(austraits$taxonomy, species_name, family)) %>% 
  left_join(sources_all, by=c("dataset_id")) 

n_records <- 
  data_geo %>% 
  group_by(trait_name) %>%
  summarise(
            Description = "",
            Type= "",
            `Records (all)` = n(),
            `Records (geo.)` = sum(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)),
            Studies = n_distinct(dataset_id),
            Species = n_distinct(species_name),
            Families = n_distinct(family),
            `Data Citations` = refs %>% unique() %>% paste(collapse = "; ")
            ) %>% 
  left_join(trait_categories, by=c("trait_name")) %>% 
  select(Tissue = tissue, Category = category, Trait = trait_name, everything()) %>% 
  arrange(Tissue, Category, Trait)

n_records$Type <- sapply(austraits$definitions$traits$elements, "[[","type")[n_records$Trait]
n_records$Description <- sapply(austraits$definitions$traits$elements, "[[","description")[n_records$Trait]

n_records %>%
  select(-Tissue, Description) %>%
  kable()
```



```{r, results="asis"}
print_defintions_element <- function(elements) {
  if(elements$type == "character") {
    sprintf("**Content:** %s\n", elements$value) %>% 
      writeLines()
  }
  
  if(elements$type == "table") {
    
    sprintf("**Content:** \n") %>% 
      writeLines()

    elements$elements %>% 
      list1_to_df() %>%
      kable() %>% 
      writeLines()
  }
}

for(v in names(austraits)) {
  elements <- austraits$definitions$austraits$elements[[v]]
  
  sprintf("### %s {#%s}\n\n**Description:** %s\n", v, v, elements$description) %>% 
    writeLines()
  
  elements %>%
    print_defintions_element()

  writeLines(c(""))
}
```

Value types

```{r, results="asis"}
austraits$definitions$value_type$values %>% 
  list1_to_df()  %>% 
  kable() %>% 
  writeLines()
```

\footnotesize

# Data sources:

## Version 1 - via bib.print

```{r, results='asis', eval=TRUE}
sources_unique <-
  bind_rows(
    austraits$methods %>% select(citation = source_primary_citation)  %>% mutate(type="primary"),
    austraits$methods %>% select(dataset_id, citation = source_secondary_citation) %>% mutate(type="secondary")
  ) %>%
  select(citation) %>%
            distinct() %>% 
            mutate(source_number=1:n())

sprintf("%s. %s", sources_unique$source_number, sources_unique$citation) %>% paste(collapse = "\n\n") %>% writeLines()

```

## Version 3 - via csl

```{r, results='asis', eval=FALSE}

austraits$sources %>% sapply(function(i) i$key) -> keys

sprintf("@%s",keys) %>% paste(collapse = "; ") %>% writeLines()
```


## References
