---
title: "Austraits -- a curated plant trait database for the Australian flora"
csl: assets/nature.csl
editor_options:
  chunk_output_type: console
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
  word_document:
    reference_docx: assets/manuscriptstyle.docx
header-includes:
- \usepackage{inputenc}
- \usepackage[T1]{fontenc}
- \usepackage{float}
- \usepackage{fontspec}
- \usepackage{unicode-math}
# - \setmainfont{Arial}
# - \setmathfont{Cambria Math}
bibliography: [data/references_ms.bib]
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
root.dir = rprojroot::find_root("austraits_ms.Rproj")
knitr::opts_knit$set(root.dir = root.dir)
knitr::opts_chunk$set(echo=FALSE, cache=FALSE, results='asis', message=FALSE, warning=FALSE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(knitr)
library(tidyverse)
library(rmarkdown)

source("R/ms.R")

austraits <- readRDS("data/austraits_2.0.0.rds")
```

```{r authors, results='asis', echo=FALSE}
authors_build <- read_csv("data/lead_authors.csv", col_types = cols(.default = "c"))

data_contributors <- 
  austraits$contributors %>% 
    filter(
          # old studies
          !dataset_id %in% c("Lawes_2012", "Westman_1977", "Hall_1981", "Hocking_1982", "Hocking_1986", "Toelken_1996", "Brock_1993", "Forster_1992", "Forster_1995", "Goble_1981"),
           !role %in% c("assistant"),
           # deceased
           !name %in% c("Peter Clarke", "Barbara Rice", "Peter Myerscough", "Lyn Craven", "Harold Trevor Clifford", "William Cooper")
           ) %>% 
    mutate(year = dataset_id %>% str_split_fixed("_", 4) %>% .[,2]) %>% 
    arrange(year) %>%
    # take most recent address for each author
    group_by(name) %>% 
    summarise(institution = last(institution),
              dataset_ids = paste(dataset_id, collapse = ", ")) %>% 
    ungroup() %>% 
    distinct() %>% 
    mutate(surname = str_split(name, " ") %>% map_chr(last)) %>% 
    rename(affiliation = institution) %>%
#    bind_rows(
#      read_csv("data/data_pending.csv")) %>%
    arrange(surname) %>% 
    select(-surname)

authors <- bind_rows(authors_build, 
                     data_contributors %>% filter(! (name %in% authors_build$name))
                    )

#  authors %>% select(dataset_ids, everything()) %>% mutate_all(~ replace_na(.x, "")) %>% write_csv("data/author_list.csv")

# Update author info from google sheets

affils <- tibble(affiliation=unique(authors$affiliation), 
                 label = seq_len(length(affiliation)))
authors <- left_join(authors, affils, by = "affiliation")

authors$label[1:2] <- sprintf("%s,\\*", authors$label[1:2])

# print list of authors

sprintf("%s^%s^", authors$name, authors$label) %>% paste0(collapse = ", ") %>% sprintf("**Authors:** %s", .) %>% writeLines()

writeLines("\n\n")

writeLines("^\\*^ contributed equally\n\n")

# print list of affiliations
sprintf("^%s^ %s", affils$label, affils$affiliation) %>% paste0(collapse = "; ")  %>% sprintf("**Affiliations:** %s", .) %>% writeLines()

```

### Abstract

We introduce the AusTraits database - a compilation of measurements of plant traits for taxa in the Australian Flora (hereafter AusTraits). AusTraits synthesises data on `r austraits$traits$trait_name %>% n_distinct()` traits across `r austraits$traits$taxon_name %>% n_distinct()` taxa from field campaigns, published literature, taxonomic monographs, and individual taxa descriptions. Traits
vary in scope from physiological measures of performance (e.g. photosynthetic gas exchange, water-use efficiency) to morphological
parameters (e.g. leaf area, seed mass, plant height) which link to aspects of ecological variation. AusTraits contains curated and
harmonised individual-, species- and genus-level observations coupled to, where available, contextual information on site
properties. This data descriptor provides information on Version `r austraits$build_info$version` of AusTraits which contains data for `r austraits$traits %>% nrow()` trait-by-taxa combinations. We envision AusTraits as an on-
going collaborative initiative for easily archiving and sharing trait data to increase our collective understanding of the Australian flora.

## Todo

Refs


* Australian Plant Census, Centre of Australian National Biodiversity Research, Council of Heads of Australasian Herbaria, (14/05/2020) https://id.biodiversity.org.au/tree/51354547
* Australian Plant Name Index (continuously updated), Centre of Australian National Biodiversity Research, www.biodiversity.org.au/nsl/services/apni (14/05/2020)



## Background and Summary

Species traits are essential metrics for comparing ecological strategies in plants arrayed across environmental space or evolutionary lineages [@diaz2016global; @kunstler2016plant; @zanne2014three; @cornwell2014functional]. Broadly, a trait is any measurable property of a plant capturing aspects of its structure or function [@chapin1993evolution; @adler2014functional; @diaz1998plant]. Traits thereby provide useful indicators of species behaviours in communities and ecosystems, regardless of their taxonomy [@violle2007let; @funk2017revisiting]. Through targeted global initiatives the volume of available trait information for plants has grown rapidly in the last two decades. However, the geographic coverage of trait observations across the globe is patchy, limiting detailed analyses of trait variation and diversity in some regions. One such region is Australia; a continent with a flora of c. 24,000 native higher-plant species [@council2010australian]. While significant investment has been made in curating and digitising herbarium collections in Australia over the last two decades (e.g. The Australian Virtual Herbarium houses ~7 million specimen occurrence records; https://avh.ala.org.au), no complementary resource yet exists for consolidating information on plant traits. 

Here we introduce the AusTraits database (hereafter simply AusTraits) - a compilation of plant traits for the Australian flora. Currently, AusTraits draws together `r austraits$sources %>% length()` primary sources – including published scientific papers, floras, and taxonomic descriptions– and contains `r austraits$traits %>% nrow()` measurements spread across `r austraits$traits$trait_name %>% n_distinct()` different traits for  `r austraits$traits$taxon_name %>% n_distinct()` taxa (Table 1; available online only). By providing a harmonised and curated dataset on `r austraits$traits$trait_name %>% n_distinct()` plant traits, AusTraits contributes substantially to filling the gap in Australian and global biodiversity resources. Prior to the development of AusTraits, data on Australian plant traits existed largely as a series of disconnected datasets collected by individual laboratories or initiatives (but see @guerin2017opportunities). Global initiatives, such as the TRY database [@Kattge-2020] and Open Traits Network [@Gallagher-2019], have been working towards sharing of data about plant traits though large numbers of Australian plant taxa remain unrepresented. 

To assemble AusTraits from diverse primary sources and make it available for reuse, we needed to overcome three main types of challenges (Figure 1). These included: 1) **Accessing** data from diverse original sources, including field studies, online databases, scientific articles, and published taxonomic floras; 2) **Harmonising** these diverse datasets into a federated resource, with common units, trait names, and data formats; and 3) **Distributing** versions of the data under suitable license. Successive versions of AusTraits will iterate through these to incorporate new data and correct identified errors.  We developed a workflow for harmonising and distributing data, drawing from emerging community standards and our collective experience building traits databases. Combined, the tools applied ensure current best-practices in the construction and distribution of data resources, by achieving the following outcomes:

  - A reproducible and extensible compilation process from raw data to assembled dataset;
  - Transparent mapping of original values (taxon names, trait names, units) into the harmonised dataset;
  - High quality data for end users; 
  - Easy addition of new data and correction of community-reported errors; 
  - Satisfying the FAIR principles [@wilkinson2016fair], i.e. standards needed to make data resources Findable, Accessible, Interoperable, and Reusable; and
  - Recognition of contributors through citation of this resource and primary sources. 

We envision AusTraits as an on-going collaborative initiative for easily archiving and sharing trait data to accelerate our collective understanding the Australian flora. It is anticipated that open access to a comprehensive resource like AusTraits will generate significant new knowledge about the Australian flora across multiple scales of interest. AusTraits will likely reduce duplication of effort in the compilation of plant trait data, particularly for research students and government agencies seeking to create trait-based answers to their questions.

### Methodology

#### Primary sources

AusTraits was assembled from `r austraits$sources %>% length()` distinct sources, including published literature, field campaigns, floras, and taxonomic treatments. We identified a list of candidate traits of interest, including growth form, plant height, leaf size, specific leaf area and seed mass, though several other traits were also collected opportunistically. A full list of traits and their sources appears in Table 1 (available online only). We then identified primary sources containing measurements for these traits and sought access to this data, including both data and metadata. Each original source was designated a `dataset_id`. Ordinarily the id is the surname of first author and year of publication, for the source’s primary citation (e.g. Falster_2005, for Dataset citation 40). Details from each source were saved with minimal modification into two plain text files:

1.	`data.csv`: a table containing the actual trait data in comma-separated values format;
2.	`metadata.yml`: contains relevant metadata for the study, as well as options for mapping trait names and units onto standard types, and any substitutions applied to the data in processing.

These two files provide all the information needed to compile each study into a standardised format. 

#### Schema

The schema of AusTraits broadly follows the principles of the established Observation and Measurement Ontology [@madin2007ontology] in that, where available, trait data are connected to contextual information about the collection site (e.g. location co-ordinates, soil conditions, number of replicates) and information about the methods used to derive measurements (e.g. number of replicates, equipment used where available). The target format contains eight core objects, as described in Table 2. The contents of several of these objects are described further in Tables 3-6. This format was developed to include sufficient information about the data and methods used to collect trait measurements in each source. Where possible, trait measurement was recorded as being one of several possible `value_type` (Table 7), reflecting the type of measurement recorded.

#### Harmonisation

To harmonise each source into the common AusTraits format we applied a reproducible and transparent workflow (Figure 1), written in R [@R-2020] and using custom code and drawing on functions from the packages `tidyverse` [@wickham2016tidyverse], `stringr` [@wickham2017stringr], `yaml` [@stephens2014yaml], `remake` [@fitzjohn2016remake],  `knitr` [@xie1general] and `rmarkdown` [@allaire2015rmarkdown]. In this workflow, we performed a series of operations, including reformatting data into standardising format, generating observation id’s for each individual measured, transforming variable names into common terms, transforming data common units, standardising terms for categorial variables, encoding suitable metadata, and flagging data that did not pass quality checks. 

To enhance data quality, we produced detailed reports for each variable and source. These reports were reviewed both by AusTraits compilers as well as data contributors. Whilst all care is taken to curate datasets in AusTraits this is not intended to absolve individual researchers from ensuring the appropriate use of the data provided. 

#### Code Availability

All code, raw and compiled data are hosted within a GitHub repository under the Trait Ecology and Evolution organisation (see https://github.com/traitecoevo/austraits.build, https://github.com/traitecoevo/austraits). Sequential versions of both source and compiled dataset are also being archived within Zenodo [@falster_2019]. The archived material includes all data sources and code for rebuilding the compiled dataset.

#### Data Records

A static version of the data contained in this descriptor has been released as version`r austraits$build_info$version` of AusTraits, available on the project website (Data Citation 1) and Zenodo (Data Citation 2). Details and references for all traits are summarised in Table 1 (available online only). The latest data can be downloaded directly from the project website https://github.com/traitecoevo/austraits. However, as validation (see Technical Validation, below) and data entry is ongoing, users are recommended to pull data from the static releases, to ensure results in their downstream analyses remain consistent as the database is updated. 

We envision AusTraits as a community resource and we encourage engagement from users on maintaining the quality and usability of the dataset. For instance, we welcome the reporting of possible errors, as well as additions and edits to the online documentation for AusTraits that make using the existing data, or adding new data, easier for the community.

#### Technical Validation

AusTraits is curated on a voluntary basis. Quality control of data and editorial procedures include: 

  - **Automated tests** which confirm that the taxa names provided can be mapped onto accepted names on The Plant List, that values for continuous traits fall within the accepted range for the trait, and that values for categorical traits are on a list of accepted values maintained by the creators. Data that does not pass these tests is moved to a separate spreadsheet (“excluded_data”) that is also made available for use if desired. 
  
  - **Detailed review of each source based on bespoke reports**: A report is generated for each source, showing all data and metadata, and is checked by both an AusTraits curator and, where possible, the original contributor for accuracy. In these reports, observations for each trait are plotted against all other values for the trait in AusTraits. This allows AusTraits curators and contributors to quickly visually check the data to ensure it plots against other trait values as expected. Corrections suggested by contributors are combined back into AusTraits and made available with the next static release.  
  
  - **User feedback**: Data issues can be reported for any observation on the project website.

#### Usage Notes

Each data release is a compressed folder containing separate files for each of the major components of AusTraits (Table 2). Detailed examples for analysis are available on the project website. 

#### Acknowledgement

DSF was supported by Australian Research Council Future Fellowship (FT160100113), RVG was supported by Australian Research Council DECRA Fellowship (DE170100208). 

We acknowledge XXXXXXXXXXx institutions, who


#### Author contributions

RVG, IJW conceived the original idea; RVG, EHW, CB collated data from primary sources; DSF developed the workflow for the harmonising of data and led all coding; EHW, DI, SCA, JL contributed to coding; EHW, CB, JL, SA error-checked trait observations; DI developed figures for the paper; DSF, RVG, DI, EHW wrote the first draft of the paper. All other authors contributed the raw data and metadata undeprinning the resource and reviewed the harmonised data for errors.

#### Competing interests

The authors have no conflicts of interest to declare. 


```{r austraits}
## Assumes to items exist in global name space
austraits <- readRDS("data/austraits_2.0.0.rds")

definitions <- austraits$definitions

tmp <- RefManageR::WriteBib(austraits$sources, "data/references_data.bib")

# check non ASCII file
#tools::showNonASCIIfile("references.bib")

sources_all <- 
  bind_rows(
    austraits$methods %>% select(dataset_id, citation = source_primary_key) %>% 
            distinct() %>% mutate(type="primary"),
    austraits$methods %>% select(dataset_id, citation = source_secondary_key) %>% 
            distinct() %>% mutate(type="secondary")
  ) %>% 
  na.omit() %>% 
  arrange(dataset_id) %>% 
  group_by(dataset_id) %>% 
  summarise(refs = sprintf("@%s", citation) %>% 
  paste(collapse = "; "))

```

### Overview

AusTraits harmonises data on `r austraits$traits$trait_name %>% unique() %>% length()` traits from `r austraits$methods$dataset_id %>% unique() %>% length()` different sources, including field campaigns, published literature, taxonomic monographs, and individual taxa descriptions.

This document provides information on the structure of AusTraits and corresponds to Version `r austraits$definitions$austraits$elements$build_info$elements$version$value` of the dataset. 

### Data structures

\clearpage 

## Figures  

![The data curation pathway used to assemble the AusTraits database.** Trait observations are accessed from original data sources, including published floras and field campaigns. Factors such as units and taxonomy are harmonised to a common standard. Versioned releases are distributed to users, allowing the dataset to be used and re-used in a reproducible way. Errors are corrected and new datasets added via the blue path for sequential releases of the database.](figures/Pipeline.png)

![(a.) AusTraits’ sites (orange) within Australia’s precipitation-temperature space (dark-grey) superimposed upon Whittaker’s major biomes diagram. Climate data were extracted from Worldclim (www.worldclim.org).(B.) Locations of georeferenced-sites grouped by plant tissues ](figures/austraits_fig_2_biome_map.pdf)


![Overview of the number of taxa with which traits are measured within each plant tissue and trait category; (A.) accounts for the georeferenced trait data (correspond with Fig 2B) whereas (B.) for the non-georeferenced trait data. ](figures/austraits_fig_3_composition.pdf)

![The phylogenetic representation of traits in the AusTraits database for the subset of 2000 randomly sampled taxa. The heatmap colour intensity denotes the number of traits measured within each plant tissue. The most widespread family names (with more than ten taxa) are labelled on the edge of the tree.](figures/austraits_fig_4_austraits_phlogenetic_coverage.pdf)

\clearpage 

<!-- Cite: -->
  <!-- G Yu, DK Smith, H Zhu, Y Guan, TTY Lam*. ggtree: an R package for visualization and annotation of phylogenetic trees with their covariates and other associated data. Methods in Ecology and Evolution. 2017, 8(1):28-36. doi: 10.1111/2041-210X.12628.  -->
  <!-- G Yu*, TTY Lam, H Zhu, Y Guan*. Two methods for mapping and visualizing associated data on phylogeny using ggtree. Molecular Biology and Evolution, 2018, 35(2):3041-3043. doi: 10.1093/molbev/msy194. -->


## Tables  

Table 1:  Main elements of Austraits

```{r}
tibble(
  Element = names(austraits), 
  Contents = sapply(austraits$definitions$austraits$elements, "[[", "description") 
  ) %>% 
  kable()
```

Table 2: Traits represented in database
```{r}
sites <- austraits$sites %>% 
  filter(site_property %in%  c("longitude (deg)","latitude (deg)")) %>% 
  spread(site_property, value)

trait_categories <- read_csv("data/trait_categories.csv", col_types = cols(.default = "c"))

data_geo <- 
  left_join(by=c("dataset_id", "site_name"),
      select(austraits$traits, -original_name), sites) %>%
  left_join(by="taxon_name",
      select(austraits$taxa, taxon_name, family)) %>% 
  left_join(sources_all, by=c("dataset_id")) 

n_records <- 
  data_geo %>% 
  group_by(trait_name) %>%
  summarise(
            Description = "",
            Type= "",
            `Records (all)` = n(),
            `Records (geo.)` = sum(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)),
            Studies = n_distinct(dataset_id),
            Taxon = n_distinct(taxon_name),
            Families = n_distinct(family),
            `Data Citations` = refs %>% unique() %>% paste(collapse = "; ")
            ) %>% 
  left_join(trait_categories, by=c("trait_name")) %>% 
  select(Tissue = tissue, Category = category, Trait = trait_name, everything()) %>% 
  arrange(Tissue, Category, Trait)

n_records$Type <- sapply(austraits$definitions$traits$elements, "[[","type")[n_records$Trait]
n_records$Description <- sapply(austraits$definitions$traits$elements, "[[","description")[n_records$Trait]

n_records %>%
  select(-Tissue, Description) %>%
  kable()
```



```{r, results="asis", eval=FALSE}
print_defintions_element <- function(elements) {
  if(elements$type == "character") {
    sprintf("**Content:** %s\n", elements$value) %>% 
      writeLines()
  }
  
  if(elements$type == "table") {
    
    sprintf("**Content:** \n") %>% 
      writeLines()

    elements$elements %>% 
      list1_to_df() %>%
      kable() %>% 
      writeLines()
  }
}

for(v in names(austraits)) {
  elements <- austraits$definitions$austraits$elements[[v]]
  
  sprintf("### %s {#%s}\n\n**Description:** %s\n", v, v, elements$description) %>% 
    writeLines()
  
  elements %>%
    print_defintions_element()

  writeLines(c(""))
}
```

Value types

```{r, results="asis"}
austraits$definitions$value_type$values %>% 
  list1_to_df()  %>% 
  kable() %>% 
  writeLines()
```

\footnotesize

### Data sources:

#### Version 1 - via bib.print

```{r, results='asis', eval=TRUE}
sources_unique <-
  bind_rows(
    austraits$methods %>% select(citation = source_primary_citation)  %>% mutate(type="primary"),
    austraits$methods %>% select(dataset_id, citation = source_secondary_citation) %>% mutate(type="secondary")
  ) %>%
  select(citation) %>%
            distinct() %>% 
            mutate(source_number=1:n())

sprintf("%s. %s", sources_unique$source_number, sources_unique$citation) %>% paste(collapse = "\n\n") %>% writeLines()

```

#### Version 3 - via csl

```{r, results='asis', eval=FALSE}

austraits$sources %>% sapply(function(i) i$key) -> keys

sprintf("@%s",keys) %>% paste(collapse = "; ") %>% writeLines()
```


### References
