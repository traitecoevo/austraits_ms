---
title: "Austraits â€“ a curated plant trait database for the Australian flora"
bibliography: references.bib
csl: assets/nature.csl  
output:
  word_document:
    reference_docx: assets/manuscriptstyle.docx
editor_options:
  chunk_output_type: console
---


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
root.dir = rprojroot::find_root("austraits_ms.Rproj")
knitr::opts_knit$set(root.dir = root.dir)
knitr::opts_chunk$set(echo=FALSE, cache=FALSE, results='asis', message=FALSE, warning=FALSE)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(knitr)
library(tidyverse)
library(rmarkdown)

source("R/ms.R")
```

```{r authors, results='asis', echo=FALSE}
authors <- read_csv("data/authors.csv", col_types = cols(.default = "c"))

affils <- tibble(Affiliation=unique(authors$Affiliation), 
                 label = letters[seq_len(length(Affiliation)) ])
authors <- left_join(authors, affils, by = "Affiliation")

# print list of authors
sprintf("%s^%s^", authors$Author, authors$label) %>% paste0(collapse = ", ") %>% writeLines()

writeLines("\n\n")

# print list of affiliations
sprintf("^%s^ %s", affils$label, affils$Affiliation) %>% paste0(collapse = "; ") %>% writeLines()
```

```{r austraits}


## Assumes to items exist in global name space
if(!exists("austraits")) {
  austraits <- readRDS("data/austraits.rds")
  # stop("austraits must exist in global name space to knit a report")
}

definitions <- austraits$definitions

sources_all <- 
  bind_rows(
    austraits$methods %>% select(dataset_id, citation = source_primary_citation) %>% distinct() %>% mutate(type="primary"),
    austraits$methods %>% select(dataset_id, citation = source_secondary_citation) %>% distinct() %>% mutate(type="secondary")
  ) %>% 
  na.omit() %>% 
  arrange(dataset_id) 

sources_unique <- tibble(citation=unique(sources_all$citation)) %>% mutate(source_number=1:n())

sources_all <- sources_all %>% left_join(sources_unique, by = "citation")

refs <- sources_all %>% group_by(dataset_id) %>% 
  summarise(refs = paste(sort(source_number), collapse = ", "))

```

# Overview

AusTraits harmonises data on `r austraits$traits$trait_name %>% unique() %>% length()` traits from `r austraits$methods$dataset_id %>% unique() %>% length()` different sources, including field campaigns, published literature, taxonomic monographs, and individual species descriptions.

This document provides information on the structure of AusTraits and corresponds to Version `r austraits$definitions$austraits$elements$build_info$elements$version$value` of the dataset. 

# Data structures

# Tables

Table 1:  Main elements of Austraits

```{r}
tibble(
  Element = names(austraits), 
  Contents = sapply(austraits$definitions$austraits$elements, "[[", "description") 
  ) %>% 
  kable()
```

Table 2: Traits represented in database
```{r}
sites <- austraits$sites %>% 
  filter(site_property %in%  c("longitude (deg)","latitude (deg)")) %>% 
  spread(site_property, value)

trait_categories <- read_csv("data/trait_categories.csv")

data_geo <- 
  left_join(by=c("dataset_id", "site_name"),
      select(austraits$traits, -original_name), sites) %>%
  left_join(by="species_name",
      select(austraits$taxonomy, species_name, family)) %>% 
  left_join(refs, by=c("dataset_id")) 

n_records <- 
  data_geo %>% 
  group_by(trait_name) %>%
  summarise(
            Description = "",
            Type= "",
            `Records (all)` = n(),
            `Records (geo.)` = sum(!is.na(`longitude (deg)`) & !is.na(`latitude (deg)`)),
            Studies = n_distinct(dataset_id),
            Species = n_distinct(species_name),
            Families = n_distinct(family),
            `Data Citations` = unique(refs) %>% paste(collapse = ", ")
            ) %>% 
  left_join(trait_categories, by=c("trait_name")) %>% 
  select(Tissue = tissue, Category = category, Trait = trait_name, everything()) %>% 
  arrange(Tissue, Category, Trait)

n_records$Type <- sapply(austraits$definitions$traits$elements, "[[","type")[n_records$Trait]
n_records$Description <- sapply(austraits$definitions$traits$elements, "[[","description")[n_records$Trait]

n_records %>%
  kable()
```



```{r, results="asis"}
print_defintions_element <- function(elements) {
  if(elements$type == "character") {
    sprintf("**Content:** %s\n", elements$value) %>% 
      writeLines()
  }
  
  if(elements$type == "table") {
    
    sprintf("**Content:** \n") %>% 
      writeLines()

    elements$elements %>% 
      list1_to_df() %>%
      kable() %>% 
      writeLines()
  }
}

for(v in names(austraits)) {
  elements <- austraits$definitions$austraits$elements[[v]]
  
  sprintf("### %s {#%s}\n\n**Description:** %s\n", v, v, elements$description) %>% 
    writeLines()
  
  elements %>%
    print_defintions_element()

  writeLines(c(""))
}
```

Value types

```{r, results="asis"}
austraits$definitions$value_type$values %>% 
  list1_to_df()  %>% 
  kable() %>% 
  writeLines()
```

\footnotesize

# Data sources:

```{r, results='asis'}
sprintf("%s. %s", sources_unique$source_number, sources_unique$citation) %>% paste(collapse = "\n\n") %>% writeLines()
```


## References
